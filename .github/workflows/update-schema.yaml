name: Update MoH schema

on:
  push:
    branches:
      - develop
      - auto_generate_schema
  pull_request:
    branches:
      - develop

jobs:
  generate-moh-schema:
    name: Generate OpenAPI schema using the current MoH model
    runs-on: ubuntu-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v3
        with:
          submodules: true
      
      - name: Install Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10' 
      
      - name: Install dependencies
        run: python -m pip install -r requirements.txt
      
      - name: Generate new schema.yml
        run: python manage.py spectacular --file ./chord_metadata_service/mohpackets/docs/schema.yml --validate --fail-on-warn
      
      - name: Update schema.yml in repo
        uses: test-room-7/action-update-file@v1
        with: 
          file-path: chord_metadata_service/mohpackets/docs/schema.yml
          commit-msg: Updated schema.yml
          github-token: ${{ secrets.GITHUB_TOKEN }}