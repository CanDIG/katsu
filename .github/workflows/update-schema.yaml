name: Update MoH schema

on:
  push:
    branches:
      - develop
  pull_request:
    branches:
      - develop

jobs:
  generate-moh-schema:
    name: Update OpenAPI schema using current MoH model
    runs-on: ubuntu-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v2
        with:
          submodules: true

      - name: Install Python dependencies
        run: python -m pip install -r requirements-candig-base.txt

      - name: Install Node.js dependencies
        run: |
          npm install --global npm@latest
          npm ci

      - name: Install widdershins
        run: npm install -g widdershins

      - name: Generate new schema.yml
        run: python manage.py spectacular --file ./chord_metadata_service/mohpackets/docs/schema.yml --validate --fail-on-warn

      - name: Convert schema to OpenAPI documentation
        run: |
          npx widdershins ./chord_metadata_service/mohpackets/docs/schema.yml -o ./chord_metadata_service/mohpackets/docs/openapi.md -u ./chord_metadata_service/mohpackets/docs/widdershins/templates/openapi3 -c true --omitHeader true

      - name: Update schema.yml and openapi.md in repo
        uses: gavinr/actions-update-file@v1.2.0
        with:
          files: |
            chord_metadata_service/mohpackets/docs/schema.yml
            chord_metadata_service/mohpackets/docs/openapi.md
          commit-message: Updated schema and OpenAPI documentation
          author-name: GitHub Actions
          author-email: actions@github.com
          branch: develop
          github-token: ${{ secrets.GITHUB_TOKEN }}
